name: Deploy Article System

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Debug - List files
      run: |
        echo "ðŸ“ é¡¹ç›®ç»“æž„ï¼š"
        find . -type f -name "*.html" -o -name "*.js" | sort
        echo ""
        echo "ðŸ“ articleç›®å½•ï¼š"
        ls -la article/ || echo "articleç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "ðŸ“ jsç›®å½•ï¼š"
        ls -la article/js/ || echo "jsç›®å½•ä¸å­˜åœ¨"
        
    - name: Create auth.js from environment variables
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      run: |
        echo "ðŸ”§ å¼€å§‹åˆ›å»º auth.js..."
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p article/js
        
        # ç”Ÿæˆ auth.js æ–‡ä»¶
        cat > article/js/auth.js << 'EOF'
        // auth.js - è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶
        // ç”Ÿæˆæ—¶é—´: $(date)
        
        // Supabaseé…ç½®
        window.supabaseConfig = {
            url: '${{ secrets.SUPABASE_URL }}',
            anonKey: '${{ secrets.SUPABASE_ANON_KEY }}',
            adminPassword: '${{ secrets.ADMIN_PASSWORD }}'
        };
        
        // å¯†ç éªŒè¯å‡½æ•°
        window.verifyPassword = function(password) {
            return password === window.supabaseConfig.adminPassword;
        };
        
        console.log('âœ… auth.js å·²åŠ è½½ - Supabase URL:', window.supabaseConfig.url ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®');
        EOF
        
        # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶å†…å®¹ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
        echo "ðŸ“„ ç”Ÿæˆçš„æ–‡ä»¶å†…å®¹ï¼ˆæ•æ„Ÿä¿¡æ¯å·²éšè—ï¼‰ï¼š"
        sed 's/\${{ secrets\.SUPABASE_URL }}/[HIDDEN_URL]/g; s/\${{ secrets\.SUPABASE_ANON_KEY }}/[HIDDEN_KEY]/g; s/\${{ secrets\.ADMIN_PASSWORD }}/[HIDDEN_PASSWORD]/g' article/js/auth.js
        
        echo ""
        echo "âœ… auth.js å·²åˆ›å»º"
        ls -la article/js/auth.js
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        force_orphan: true
